// This is the Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SALES_EXECUTIVE
  RECEPTIONIST
  RECEPTIONIST_2
  ADMIN
}

enum LeadStatus {
  VISIT
  REVISIT
  BOOKED
  CANCELLED
  FOLLOW_UP
}

enum LeadSource {
  WALK_IN
  SOCIAL_MEDIA
  GOOGLE
  WEBSITE
  PROPERTY_PORTAL
  ADVERTISEMENT
  REFERRAL
  CHANNEL_PARTNER
  OTHER
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   // Hashed
  name      String
  phone     String?
  role      Role     @default(RECEPTIONIST)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  leads     Lead[]   @relation("AssignedLeads")
}

model Lead {
  id              Int        @id @default(autoincrement())
  friendlyId      String     @unique // e.g. LEAD-0001
  
  // STEP 1: Personal Info
  title           String?    // Mr, Ms, etc
  firstName       String
  middleName      String?
  lastName        String
  customerName    String?    // Combined for easy display
  gender          String?
  age             String?
  nationality     String?
  aadhar          String?
  email           String?
  phone           String     @unique
  maritalStatus   String?
  dob             String?
  spouseName      String?
  spousePhone     String?
  
  // STEP 2: Contact & Work Info
  residenceType   String?    // Owned, Rented
  address         String?    @db.Text
  location        String?
  subLocation     String?
  pinCode         String?
  workType        String?    // Salaried, Self-employed, etc
  jobTitle        String?
  orgName         String?
  companyType     String?
  businessType    String?
  yearsInBusiness String?
  fieldOfWork     String?
  yearsOfExperience String?
  prevOccupation  String?
  yearsSinceRetirement String?
  department      String?
  designation     String?
  yearsOfService  String?

  // STEP 3: Property Details
  purpose         String?    // Primary Residence, Investment, Second Home
  config          String?    // 1 BHK, 2 BHK, etc
  budget          String?
  possession      String?    // 2027, 2028, etc
  floor           String?    // Lower, Middle, Upper
  view            String?    // City, Mangrove, etc

  // STEP 4: Feedback & Sources
  source          LeadSource @default(WALK_IN)
  sourcesList     String?    @db.Text // Store selected sources as comma-separated or JSON
  refName         String?
  refContact      String?
  cpFirm          String?
  cpExec          String?
  cpPhone         String?
  signature       String?    @db.LongText // Base64 signature
  consent         Boolean    @default(true)
  
  // Metadata
  status          LeadStatus @default(VISIT)
  projectId       Int?
  project         Project?   @relation(fields: [projectId], references: [id])
  assignedToId    Int?
  assignedTo      User?      @relation("AssignedLeads", fields: [assignedToId], references: [id])
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  // Logs for interactions
  interactions    Interaction[]
  feedbacks       Feedback[]

  @@index([friendlyId])
  @@index([phone])
  @@index([createdAt])
}

model Feedback {
  id              Int      @id @default(autoincrement())
  leadId          Int
  lead            Lead     @relation(fields: [leadId], references: [id])
  onboarding      Int      // 1-5
  staff           Int      // 1-5
  projectShared   Int      // 1-5
  explanation     Int      // 1-5
  overall         Int      // 1-5
  comment         String?  @db.Text
  createdAt       DateTime @default(now())
}

model Interaction {
  id        Int      @id @default(autoincrement())
  leadId    Int
  lead      Lead     @relation(fields: [leadId], references: [id])
  type      String   // Visit, Call, Note
  content   String?  @db.Text
  createdAt DateTime @default(now())
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  location    String
  description String?  @db.Text
  totalUnits  Int?
  available   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  leads       Lead[]
}

model ChannelPartner {
  id          Int      @id @default(autoincrement())
  cpName      String
  firmName    String
  phone       String   @unique
  email       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([phone])
  @@index([createdAt])
}
